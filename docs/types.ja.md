# å‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

`@enslo/sd-metadata` ã®å®Œå…¨ãªå‹ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã§ã™ã€‚

ğŸŒ **[English version](./types.md)**

## ç›®æ¬¡

- [ã‚³ã‚¢å‹](#ã‚³ã‚¢å‹)
  - [`ParseResult`](#parseresult)
  - [`GenerationMetadata`](#generationmetadata)
  - [`RawMetadata`](#rawmetadata)
  - [`WriteResult`](#writeresult)
- [ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å‹](#ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å‹)
  - [`StandardMetadata`](#standardmetadata)
  - [`NovelAIMetadata`](#novelaimetadata)
  - [`ComfyUIMetadata`](#comfyuimetadata)
- [è¨­å®šå‹](#è¨­å®šå‹)
  - [`ModelSettings`](#modelsettings)
  - [`SamplingSettings`](#samplingsettings)
  - [`HiresSettings`](#hiressettings)
  - [`UpscaleSettings`](#upscalesettings)
  - [`CharacterPrompt`](#characterprompt)
- [ComfyUIå‹](#comfyuiå‹)
  - [`ComfyNodeGraph`](#comfynodegraph)
  - [`ComfyNode`](#comfynode)
  - [`ComfyNodeInputValue`](#comfynodeinputvalue)
  - [`ComfyNodeReference`](#comfynodereference)
- [ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå›ºæœ‰ã®å‹](#ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå›ºæœ‰ã®å‹)
  - [`PngTextChunk`](#pngtextchunk)
  - [`TExtChunk`](#textchunk)
  - [`ITXtChunk`](#itxtchunk)
  - [`MetadataSegment`](#metadatasegment)
  - [`MetadataSegmentSource`](#metadatasegmentsource)

---

## ã‚³ã‚¢å‹

### `ParseResult`

`read()` é–¢æ•°ãŒè¿”ã™çµæœå‹ã€‚

```typescript
type ParseResult =
  | { status: 'success'; metadata: GenerationMetadata; raw: RawMetadata }
  | { status: 'unrecognized'; raw: RawMetadata }
  | { status: 'empty' }
  | { status: 'invalid'; message?: string };
```

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å€¤ï¼š**

- **`success`**: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ãƒ‘ãƒ¼ã‚¹ã«æˆåŠŸ
  - `metadata`: çµ±ä¸€ã•ã‚ŒãŸãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
  - `raw`: ãƒ©ã‚¦ãƒ³ãƒ‰ãƒˆãƒªãƒƒãƒ—å¤‰æ›ç”¨ã®å…ƒã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå›ºæœ‰ãƒ‡ãƒ¼ã‚¿
- **`unrecognized`**: ç”»åƒã«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ãŒãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒèªè­˜ã§ããªã„
  - `raw`: å…ƒã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒä¿æŒã•ã‚Œã‚‹
- **`empty`**: ç”»åƒã«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚‰ãªã„
- **`invalid`**: ç ´æã¾ãŸã¯éå¯¾å¿œã®ç”»åƒãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
  - `message`: ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ã‚¨ãƒ©ãƒ¼èª¬æ˜

**ä¾‹ï¼š**

```typescript
import { read } from '@enslo/sd-metadata';

const result = read(imageData);

switch (result.status) {
  case 'success':
    console.log(`Generated by ${result.metadata.software}`);
    console.log(`Prompt: ${result.metadata.prompt}`);
    break;
  
  case 'unrecognized':
    console.log('ä¸æ˜ãªãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ');
    break;
  
  case 'empty':
    console.log('ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãªã—');
    break;
  
  case 'invalid':
    console.error(`ç„¡åŠ¹ãªç”»åƒ: ${result.message}`);
    break;
}
```

---

### `GenerationMetadata`

çµ±ä¸€ã•ã‚ŒãŸãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã€‚ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹å…¨ã¦ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å‹ã®ãƒ¦ãƒ‹ã‚ªãƒ³å‹ã€‚

```typescript
type GenerationMetadata =
  | NovelAIMetadata
  | ComfyUIMetadata
  | StandardMetadata;
```

**ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å‹ã®ãƒãƒƒãƒ”ãƒ³ã‚°ï¼š**

| ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å‹ | `software` å€¤ |
| ------------- | ----------------- |
| `StandardMetadata` | `'sd-webui'` \| `'forge'` \| `'invokeai'` \| `'civitai'` \| `'hf-space'` \| `'easydiffusion'` \| `'fooocus'` \| `'ruined-fooocus'` \| `'sd-next'` \| `'forge-neo'` |
| `NovelAIMetadata` | `'novelai'` |
| `ComfyUIMetadata` | `'comfyui'` \| `'tensorart'` \| `'stability-matrix'` \| `'swarmui'` |

**å‹ã®çµã‚Šè¾¼ã¿ä¾‹ï¼š**

```typescript
if (metadata.software === 'novelai') {
  // TypeScriptã¯metadataãŒNovelAIMetadataã§ã‚ã‚‹ã“ã¨ã‚’èªè­˜
  console.log(metadata.characterPrompts);
}

if (metadata.software === 'comfyui' ||
    metadata.software === 'tensorart' ||
    metadata.software === 'stability-matrix' ||
    metadata.software === 'swarmui') {
  // TypeScriptã¯metadataãŒComfyUIMetadataã§ã‚ã‚‹ã“ã¨ã‚’èªè­˜
  if (metadata.nodes) {
    console.log('Has workflow:', Object.keys(metadata.nodes).length);
  }
}
```

---

### `RawMetadata`

ãƒ­ã‚¹ãƒ¬ã‚¹ãªãƒ©ã‚¦ãƒ³ãƒ‰ãƒˆãƒªãƒƒãƒ—å¤‰æ›ã®ãŸã‚ã«å…ƒã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ä¿æŒã€‚

```typescript
type RawMetadata =
  | { format: 'png'; chunks: PngTextChunk[] }
  | { format: 'jpeg'; segments: MetadataSegment[] }
  | { format: 'webp'; segments: MetadataSegment[] };
```

**ãªãœã“ã‚ŒãŒå¿…è¦ï¼Ÿ**

ç”»åƒã‹ã‚‰ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§åˆ¥ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¤‰æ›ã™ã‚‹å ´åˆï¼ˆä¾‹ï¼šPNG â†’ JPEGï¼‰ã€`RawMetadata` ã¯å…ƒã®æ§‹é€ ã‚’ä¿æŒã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æƒ…å ±ã‚’å¤±ã†ã“ã¨ãªãå…ƒã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«æˆ»ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

**ãƒ©ã‚¦ãƒ³ãƒ‰ãƒˆãƒªãƒƒãƒ—å¤‰æ›ä¾‹ï¼š**

```typescript
import { read, write } from '@enslo/sd-metadata';
import { convertImageFormat } from 'some-image-library';

// PNGã‹ã‚‰ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
const pngData = readFileSync('image.png');
const parseResult = read(pngData);

if (parseResult.status === 'success') {
  // ç”»åƒã‚’JPEGã«å¤‰æ›
  const jpegImageData = convertImageFormat(pngData, 'jpeg');
  
  // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’JPEGã«æ›¸ãè¾¼ã¿
  const jpegWithMeta = write(jpegImageData, parseResult);
  
  // å¾Œã§ï¼šPNGã«æˆ»ã™
  const pngImageData = convertImageFormat(jpegWithMeta.value, 'png');
  const pngWithMeta = write(pngImageData, parseResult);
  
  // å…ƒã®PNGãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãŒå®Œå…¨ã«ä¿æŒã•ã‚Œã‚‹ï¼
}
```

`raw` ãŒãªã‘ã‚Œã°ã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¯æ±ç”¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¤‰æ›ã•ã‚Œã€å…ƒã«æˆ»ã™éš›ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå›ºæœ‰ã®è©³ç´°ãŒå¤±ã‚ã‚Œã¾ã™ã€‚

---

### `WriteResult`

`write()` é–¢æ•°ãŒè¿”ã™çµæœå‹ã€‚

```typescript
export type WriteResult =
  | { ok: true; value: Uint8Array; warning?: WriteWarning }
  | { ok: false; error: { type: string; message?: string } };
```

**æˆåŠŸï¼š**

```typescript
if (result.ok) {
  saveFile('output.png', result.value);
  if (result.warning) {
    console.warn('ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ:', result.warning.reason);
  }
}
```

**ã‚¨ãƒ©ãƒ¼ï¼š**

```typescript
if (!result.ok) {
  console.error(`æ›¸ãè¾¼ã¿å¤±æ•—: ${result.error.type}`);
  if (result.error.message) {
    console.error(result.error.message);
  }
}
```

**ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—ï¼š**

- `unsupportedFormat`: ç”»åƒãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒéå¯¾å¿œ
- `conversionFailed`: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å¤‰æ›ã«å¤±æ•—
- `writeFailed`: ç”»åƒã¸ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ›¸ãè¾¼ã¿ã«å¤±æ•—

### `WriteWarning`

æ›¸ãè¾¼ã¿æ“ä½œã®è­¦å‘Šå‹ã€‚

```typescript
export type WriteWarning = {
  type: 'metadataDropped';
  reason: 'unrecognizedCrossFormat';
};
```

æ›¸ãè¾¼ã¿æ“ä½œä¸­ã«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒæ„å›³çš„ã«å‰Šé™¤ã•ã‚ŒãŸå ´åˆã«è¿”ã•ã‚Œã‚‹ï¼ˆä¾‹ï¼šæœªå¯¾å¿œãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒ­ã‚¹ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›ï¼‰ã€‚

---

## ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å‹

### `StandardMetadata`

ã»ã¨ã‚“ã©ã®SDãƒ„ãƒ¼ãƒ«ã§ä½¿ç”¨ã•ã‚Œã‚‹æ¨™æº–ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€‚

```typescript
export interface StandardMetadata extends BaseMetadata {
  software:
    | 'sd-webui'
    | 'sd-next'
    | 'forge'
    | 'forge-neo'
    | 'invokeai'
    | 'civitai'
    | 'hf-space'
    | 'easydiffusion'
    | 'fooocus'
    | 'ruined-fooocus';

  // å…±é€šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆå†…éƒ¨ã®BaseMetadataã‹ã‚‰ç¶™æ‰¿ï¼‰
  /** ãƒã‚¸ãƒ†ã‚£ãƒ–ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ */
  prompt: string;
  /** ãƒã‚¬ãƒ†ã‚£ãƒ–ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ */
  negativePrompt: string;
  /** ç”»åƒã®å¹…ï¼ˆãƒ”ã‚¯ã‚»ãƒ«ï¼‰ */
  width: number;
  /** ç”»åƒã®é«˜ã•ï¼ˆãƒ”ã‚¯ã‚»ãƒ«ï¼‰ */
  height: number;
  /** ãƒ¢ãƒ‡ãƒ«è¨­å®š */
  model?: ModelSettings;
  /** ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°è¨­å®š */
  sampling?: SamplingSettings;
  /** Hires.fixè¨­å®šï¼ˆé©ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰ */
  hires?: HiresSettings;
  /** ã‚¢ãƒƒãƒ—ã‚¹ã‚±ãƒ¼ãƒ«è¨­å®šï¼ˆé©ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰ */
  upscale?: UpscaleSettings;
}
```

ã“ã‚Œã¯æœ€ã‚‚ä¸€èˆ¬çš„ãªãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å‹ã§ã™ã€‚NovelAIã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚„ComfyUIã®ãƒãƒ¼ãƒ‰ã‚°ãƒ©ãƒ•ã®ã‚ˆã†ãªãƒ„ãƒ¼ãƒ«å›ºæœ‰ã®æ‹¡å¼µãªã—ã®ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ç”Ÿæˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ã—ã¾ã™ã€‚SD WebUIã€Forgeã€InvokeAIãªã©å¤šãã®ãƒ„ãƒ¼ãƒ«ãŒã“ã®æœ€å°é™ã®æ§‹é€ ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

**ä¾‹ï¼š**

```typescript
if (metadata.software === 'forge' || metadata.software === 'sd-webui') {
  console.log('æ¨™æº–ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨');
  console.log('Sampler:', metadata.sampling?.sampler);
  console.log('Steps:', metadata.sampling?.steps);
}
```

---

### `NovelAIMetadata`

NovelAIç”Ÿæˆç”»åƒã«å›ºæœ‰ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã€‚

```typescript
export interface NovelAIMetadata extends BaseMetadata {
  software: 'novelai';
  /** V4ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é…ç½®ä½¿ç”¨æ™‚ï¼‰ */
  characterPrompts?: CharacterPrompt[];
  /** é…ç½®ã«ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åº§æ¨™ã‚’ä½¿ç”¨ */
  useCoords?: boolean;
  /** ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®é †åºã‚’ä½¿ç”¨ */
  useOrder?: boolean;
}
```

**å›ºæœ‰ã®æ©Ÿèƒ½ï¼š**

- **ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é…ç½®ï¼ˆV4ï¼‰**: NovelAI V4ã¯ç‰¹å®šã®åº§æ¨™ã«è¤‡æ•°ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é…ç½®ã™ã‚‹ã“ã¨ã‚’ã‚µãƒãƒ¼ãƒˆ
- `characterPrompts`: ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ä½ç½®æƒ…å ±ä»˜ãã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å›ºæœ‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®é…åˆ—
- `useCoords`ã€`useOrder`: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é…ç½®ã®å‹•ä½œã‚’åˆ¶å¾¡

**ä¾‹ï¼š**

```typescript
if (metadata.software === 'novelai' && metadata.characterPrompts) {
  metadata.characterPrompts.forEach(char => {
    console.log(`Character: ${char.prompt}`);
    if (char.center) {
      console.log(`  Position: (${char.center.x}, ${char.center.y})`);
    }
  });
}
```

---

### `ComfyUIMetadata`

ComfyUIãŠã‚ˆã³äº’æ›ãƒ„ãƒ¼ãƒ«ï¼ˆTensorArtã€Stability Matrixã€SwarmUIï¼‰ã‹ã‚‰ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã€‚

```typescript
export type ComfyUIMetadata =
  | BasicComfyUIMetadata
  | SwarmUIMetadata;

// å†…éƒ¨å‹ï¼š
interface BasicComfyUIMetadata extends BaseMetadata {
  software: 'comfyui' | 'tensorart' | 'stability-matrix';
  nodes: ComfyNodeGraph;  // å¿…é ˆ
}

interface SwarmUIMetadata extends BaseMetadata {
  software: 'swarmui';
  nodes?: ComfyNodeGraph;  // ã‚ªãƒ—ã‚·ãƒ§ãƒ³
}
```

**å›ºæœ‰ã®æ©Ÿèƒ½ï¼š**

- **ComfyUI/TensorArt/Stability Matrix**: `nodes` ã¯å…¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§å¸¸ã«å­˜åœ¨
- **SwarmUI**: PNGã‹ã‚‰å¤‰æ›ã•ã‚ŒãŸå ´åˆã€å…¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ `nodes` ãŒå­˜åœ¨ã™ã‚‹å¯èƒ½æ€§ã‚ã‚Šï¼ˆæ‹¡å¼µå¯¾å¿œï¼‰

**ä¾‹ï¼š**

```typescript
if (metadata.software === 'comfyui') {
  // ComfyUIã§ã¯nodesã¯å¿…ãšå­˜åœ¨
  console.log('Node count:', Object.keys(metadata.nodes).length);
}

if (metadata.software === 'swarmui') {
  // ãƒã‚¤ãƒ†ã‚£ãƒ–SwarmUI JPEG/WebPã§ã¯nodesãŒå­˜åœ¨ã—ãªã„å¯èƒ½æ€§ã‚ã‚Š
  // ãŸã ã—PNGã‹ã‚‰å¤‰æ›ã•ã‚ŒãŸå ´åˆã¯å­˜åœ¨
  if (metadata.nodes) {
    console.log('ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚ã‚Šï¼ˆPNGã¾ãŸã¯å¤‰æ›æ¸ˆã¿ï¼‰');
  } else {
    console.log('ãƒã‚¤ãƒ†ã‚£ãƒ–JPEG/WebP: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ã¿');
  }
}

// å‹ã®çµã‚Šè¾¼ã¿ã¯å…¨ã¦ã®ComfyUIäº’æ›ãƒ„ãƒ¼ãƒ«ã§æ©Ÿèƒ½
if (metadata.software === 'comfyui' ||
    metadata.software === 'tensorart' ||
    metadata.software === 'stability-matrix' ||
    metadata.software === 'swarmui') {
  // TypeScriptã¯metadataãŒComfyUIMetadataã§ã‚ã‚‹ã“ã¨ã‚’èªè­˜
  // ãŸã ã—metadata.nodesã¯ä½¿ç”¨å‰ã«ãƒã‚§ãƒƒã‚¯ãŒå¿…è¦
  if (metadata.nodes) {
    // ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆãƒãƒ¼ãƒ‰ã‚’æ¤œç´¢
    for (const [nodeId, node] of Object.entries(metadata.nodes)) {
      if (node.class_type === 'CheckpointLoaderSimple') {
        console.log('Model:', node.inputs.ckpt_name);
      }
    }
  }
}
```

## è¨­å®šå‹

### `ModelSettings`

ç”»åƒç”Ÿæˆã«ä½¿ç”¨ã•ã‚Œã‚‹ãƒ¢ãƒ‡ãƒ«è¨­å®šã€‚

```typescript
export interface ModelSettings {
  /** ãƒ¢ãƒ‡ãƒ«åï¼ˆä¾‹ï¼š"sd_xl_base_1.0.safetensors"ï¼‰ */
  name?: string;
  /** æ¤œè¨¼ç”¨ãƒ¢ãƒ‡ãƒ«ãƒãƒƒã‚·ãƒ¥ */
  hash?: string;
  /** VAEï¼ˆVariational AutoEncoderï¼‰å */
  vae?: string;
}
```

**ä¾‹ï¼š**

```typescript
if (metadata.model) {
  console.log('Model:', metadata.model.name);
  console.log('Hash:', metadata.model.hash);
  console.log('VAE:', metadata.model.vae || 'Default');
}
```

---

### `SamplingSettings`

ç”Ÿæˆæ™‚ã«ä½¿ç”¨ã•ã‚Œã‚‹ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€‚

```typescript
export interface SamplingSettings {
  /** ã‚µãƒ³ãƒ—ãƒ©ãƒ¼ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼ˆä¾‹ï¼š"Euler a"ã€"DPM++ 2M Karras"ï¼‰ */
  sampler?: string;
  /** ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—ï¼ˆã‚µãƒ³ãƒ—ãƒ©ãƒ¼ã¨åˆ¥ã®å ´åˆï¼‰ */
  scheduler?: string;
  /** ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã‚¹ãƒ†ãƒƒãƒ—æ•° */
  steps?: number;
  /** CFGï¼ˆClassifier Free Guidanceï¼‰ã‚¹ã‚±ãƒ¼ãƒ« */
  cfg?: number;
  /** å†ç¾æ€§ã®ãŸã‚ã®ãƒ©ãƒ³ãƒ€ãƒ ã‚·ãƒ¼ãƒ‰ */
  seed?: number;
  /** CLIPã‚¹ã‚­ãƒƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ */
  clipSkip?: number;
}
```

**ä¾‹ï¼š**

```typescript
if (metadata.sampling) {
  console.log('Sampler:', metadata.sampling.sampler);
  console.log('Steps:', metadata.sampling.steps);
  console.log('CFG Scale:', metadata.sampling.cfg);
  console.log('Seed:', metadata.sampling.seed);
}
```

---

### `HiresSettings`

Hires.fixï¼ˆé«˜è§£åƒåº¦ä¿®æ­£ï¼‰ã®è¨­å®šã€‚

```typescript
export interface HiresSettings {
  /** ã‚¢ãƒƒãƒ—ã‚¹ã‚±ãƒ¼ãƒ«å€ç‡ */
  scale?: number;
  /** ã‚¢ãƒƒãƒ—ã‚¹ã‚±ãƒ¼ãƒ©ãƒ¼å */
  upscaler?: string;
  /** Hiresã‚¹ãƒ†ãƒƒãƒ—æ•° */
  steps?: number;
  /** Hiresãƒ‡ãƒã‚¤ã‚ºå¼·åº¦ */
  denoise?: number;
}
```

é«˜è§£åƒåº¦å‡ºåŠ›ã®å“è³ªã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã«ç”Ÿæˆæ™‚ã«é©ç”¨ã•ã‚Œã¾ã™ã€‚

---

### `UpscaleSettings`

ç”Ÿæˆå¾Œã®ã‚¢ãƒƒãƒ—ã‚¹ã‚±ãƒ¼ãƒ«è¨­å®šã€‚

```typescript
export interface UpscaleSettings {
  /** ã‚¢ãƒƒãƒ—ã‚¹ã‚±ãƒ¼ãƒ©ãƒ¼å */
  upscaler?: string;
  /** ã‚¹ã‚±ãƒ¼ãƒ«å€ç‡ */
  scale?: number;
}
```

åˆæœŸç”Ÿæˆå¾Œã«åˆ¥ã®ã‚¢ãƒƒãƒ—ã‚¹ã‚±ãƒ¼ãƒ«ã‚¹ãƒ†ãƒƒãƒ—ã¨ã—ã¦é©ç”¨ã•ã‚Œã¾ã™ã€‚

---

### `CharacterPrompt`

NovelAI V4ç”»åƒã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä½ç½®æŒ‡å®šã€‚

```typescript
export interface CharacterPrompt {
  /** ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å›ºæœ‰ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ */
  prompt: string;
  /** ç”»åƒå†…ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä½ç½®ï¼ˆæ­£è¦åŒ– 0-1ï¼‰ */
  center?: { x: number; y: number };
}
```

**ä¾‹ï¼š**

```typescript
const character: CharacterPrompt = {
  prompt: "1girl, long hair, blue eyes",
  center: { x: 0.3, y: 0.5 } // å·¦å´ã€å‚ç›´æ–¹å‘ã«ä¸­å¤®
};
```

---

## ComfyUIå‹

### `ComfyNodeGraph`

ãƒãƒ¼ãƒ‰IDã‹ã‚‰å¯¾å¿œã™ã‚‹ãƒãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã¸ã®ãƒãƒƒãƒ—ã€‚

```typescript
export type ComfyNodeGraph = Record<string, ComfyNode>;
```

**ä¾‹ï¼š**

```typescript
const graph: ComfyNodeGraph = {
  "CheckpointLoader_Base": { /* ... */ },
  "KSampler_Primary": { /* ... */ },
  "SaveImage_Final": { /* ... */ }
};
```

---

### `ComfyNode`

ComfyUIãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚°ãƒ©ãƒ•å†…ã®å˜ä¸€ãƒãƒ¼ãƒ‰ã€‚

```typescript
export interface ComfyNode {
  /** ãƒãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¹ã‚¿ã‚¤ãƒ—ï¼ˆä¾‹ï¼š"CheckpointLoaderSimple"ã€"KSampler"ï¼‰ */
  class_type: string;
  /** ãƒãƒ¼ãƒ‰å…¥åŠ› */
  inputs: Record<string, ComfyNodeInputValue>;
  /** ãƒãƒ¼ãƒ‰ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆComfyUIã®ã¿ï¼‰ */
  _meta?: {
    /** è¡¨ç¤ºç”¨ãƒãƒ¼ãƒ‰ã‚¿ã‚¤ãƒˆãƒ« */
    title?: string;
  };
  /** å¤‰æ›´æ¤œå‡ºãƒãƒƒã‚·ãƒ¥ï¼ˆã¾ã‚Œã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç”¨ï¼‰ */
  is_changed?: string[] | null;
}
```

**ä¾‹ï¼š**

```typescript
const ksampler: ComfyNode = {
  class_type: "KSampler",
  inputs: {
    model: ["CheckpointLoader", 0],
    seed: 12345,
    steps: 20,
    cfg: 7.0,
    sampler_name: "euler_a",
    scheduler: "normal",
    denoise: 1.0
  },
  _meta: {
    title: "Primary Sampler"
  }
};
```

---

### `ComfyNodeInputValue`

ãƒãƒ¼ãƒ‰å…¥åŠ›ã®å¯èƒ½ãªå€¤ã€‚

```typescript
export type ComfyNodeInputValue =
  | string
  | number
  | boolean
  | ComfyNodeReference
  | ComfyNodeInputValue[];
```

ãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–å€¤ã€åˆ¥ã®ãƒãƒ¼ãƒ‰ã¸ã®å‚ç…§ã€ã¾ãŸã¯é…åˆ—ã‚’å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

---

### `ComfyNodeReference`

åˆ¥ã®ãƒãƒ¼ãƒ‰ã®å‡ºåŠ›ã¸ã®å‚ç…§ã€‚

```typescript
export type ComfyNodeReference = [nodeId: string, outputIndex: number];
```

**ä¾‹ï¼š**

```typescript
const modelReference: ComfyNodeReference = ["CheckpointLoader_Base", 0];

// ãƒãƒ¼ãƒ‰å…¥åŠ›ã§ä½¿ç”¨ï¼š
{
  model: ["CheckpointLoader_Base", 0],  // CheckpointLoader_Baseã®å‡ºåŠ›0ã‚’å‚ç…§
  positive: ["CLIPTextEncode_Positive", 0]
}
```

---

## ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå›ºæœ‰ã®å‹

> **æ³¨æ„ï¼š** ã“ã‚Œã‚‰ã®å‹ã¯ä¸»ã«é«˜åº¦ãªãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‚„å†…éƒ¨å®Ÿè£…ã®è©³ç´°ç”¨ã§ã™ã€‚ã»ã¨ã‚“ã©ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã“ã‚Œã‚‰ã®å‹ã‚’ç›´æ¥æ‰±ã†å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

### `PngTextChunk`

PNGãƒ†ã‚­ã‚¹ãƒˆãƒãƒ£ãƒ³ã‚¯å‹ï¼ˆtEXtã¾ãŸã¯iTXtï¼‰ã€‚

```typescript
export type PngTextChunk = TExtChunk | ITXtChunk;
```

---

### `TExtChunk`

PNG tEXtãƒãƒ£ãƒ³ã‚¯ï¼ˆLatin-1ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼‰ã€‚

```typescript
export interface TExtChunk {
  type: 'tEXt';
  /** ãƒãƒ£ãƒ³ã‚¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆä¾‹ï¼š"parameters"ã€"Comment"ï¼‰ */
  keyword: string;
  /** ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹ */
  text: string;
}
```

---

### `ITXtChunk`

PNG iTXtãƒãƒ£ãƒ³ã‚¯ï¼ˆUTF-8å›½éš›ãƒ†ã‚­ã‚¹ãƒˆï¼‰ã€‚

```typescript
export interface ITXtChunk {
  type: 'iTXt';
  /** ãƒãƒ£ãƒ³ã‚¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ */
  keyword: string;
  /** åœ§ç¸®ãƒ•ãƒ©ã‚°ï¼ˆ0=éåœ§ç¸®ã€1=åœ§ç¸®ï¼‰ */
  compressionFlag: number;
  /** åœ§ç¸®æ–¹å¼ï¼ˆ0=zlib/deflateï¼‰ */
  compressionMethod: number;
  /** è¨€èªã‚¿ã‚°ï¼ˆBCP 47ï¼‰ */
  languageTag: string;
  /** ç¿»è¨³ã•ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ */
  translatedKeyword: string;
  /** ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹ */
  text: string;
}
```

---

### `MetadataSegment`

ã‚½ãƒ¼ã‚¹è¿½è·¡æ©Ÿèƒ½ä»˜ãã®JPEG/WebPãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã€‚

```typescript
export interface MetadataSegment {
  /** ã“ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®ã‚½ãƒ¼ã‚¹ä½ç½® */
  source: MetadataSegmentSource;
  /** ç”Ÿã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ–‡å­—åˆ— */
  data: string;
}
```

ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æ­£ã—ã„ä½ç½®ã«æ›¸ãæˆ»ã™ãŸã‚ã®ãƒ©ã‚¦ãƒ³ãƒ‰ãƒˆãƒªãƒƒãƒ—å¤‰æ›ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

---

### `MetadataSegmentSource`

ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®ã‚½ãƒ¼ã‚¹ä½ç½®ã€‚

```typescript
export type MetadataSegmentSource =
  | { type: 'exifUserComment' }
  | { type: 'exifImageDescription'; prefix?: string }
  | { type: 'exifMake'; prefix?: string }
  | { type: 'jpegCom' };
```

æ­£ç¢ºãªãƒ©ã‚¦ãƒ³ãƒ‰ãƒˆãƒªãƒƒãƒ—ã®ãŸã‚ã«ã€JPEG/WebPãƒ•ã‚¡ã‚¤ãƒ«å†…ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®å‡ºæ‰€ã‚’è¿½è·¡ã—ã¾ã™ã€‚

---
