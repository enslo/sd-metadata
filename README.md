# sd-metadata

[![npm version](https://img.shields.io/npm/v/@enslo/sd-metadata.svg)](https://www.npmjs.com/package/@enslo/sd-metadata)
[![npm downloads](https://img.shields.io/npm/dm/@enslo/sd-metadata.svg)](https://www.npmjs.com/package/@enslo/sd-metadata)
[![license](https://img.shields.io/npm/l/@enslo/sd-metadata.svg)](https://github.com/enslo/sd-metadata/blob/main/LICENSE)

A TypeScript library to read and write metadata embedded in AI-generated images.

## Features

- **Multi-format Support**: PNG (tEXt / iTXt), JPEG (COM / Exif), WebP (Exif)
- **Unified API**: Simple `read()` and `write()` functions work across all formats
- **TypeScript Native**: Written in TypeScript with full type definitions included
- **Zero Dependencies**: Works in Node.js and browsers without any external dependencies
- **Format Conversion**: Seamlessly convert metadata between PNG, JPEG, and WebP
- **Lossless Round-trip**: Preserves original metadata structure when converting back to native format

## Installation

```bash
npm install @enslo/sd-metadata
```

## Tool Support

| Tool | PNG | JPEG | WebP |
| ------ | :---: | :----: | :----: |
| [NovelAI](https://novelai.net/) * | âœ… | ðŸ”„ï¸ | âœ… |
| [ComfyUI](https://github.com/comfyanonymous/ComfyUI) * | âœ… | ðŸ”„ï¸ | ðŸ”„ï¸ |
| [AUTOMATIC1111](https://github.com/AUTOMATIC1111/stable-diffusion-webui) | âš ï¸ | âš ï¸ | âš ï¸ |
| [Forge](https://github.com/lllyasviel/stable-diffusion-webui-forge) / [Forge Neo](https://github.com/neggles/sd-webui-forge-neoforge) | âœ… | âœ… | âœ… |
| [InvokeAI](https://github.com/invoke-ai/InvokeAI) | âœ… | ðŸ”„ï¸ | ðŸ”„ï¸ |
| [SwarmUI](https://github.com/Stability-AI/StableSwarmUI) * | âœ… | âœ… | âœ… |
| [Civitai](https://civitai.com/) | âš ï¸ | âœ… | âš ï¸ |
| [TensorArt](https://tensor.art/) | âœ… | ðŸ”„ï¸ | ðŸ”„ï¸ |
| [Stability Matrix](https://github.com/LykosAI/StabilityMatrix) | âœ… | ðŸ”„ï¸ | ðŸ”„ï¸ |
| [HuggingFace Space](https://huggingface.co/spaces) | âœ… | ðŸ”„ï¸ | ðŸ”„ï¸ |
| [Ruined Fooocus](https://github.com/runew0lf/RuinedFooocus) | âœ… | ðŸ”„ï¸ | ðŸ”„ï¸ |
| [Easy Diffusion](https://github.com/easydiffusion/easydiffusion) | âš ï¸ | âš ï¸ | âš ï¸ |
| [Fooocus](https://github.com/lllyasviel/Fooocus) | âš ï¸ | âš ï¸ | âš ï¸ |

**Legend:**

- âœ… **Fully Supported** - Formats natively supported by the tool, verified with sample files
- ðŸ”„ï¸ **Extended Support** - sd-metadata specific parsers, cross-format conversion supported
- âš ï¸ **Experimental** - Implemented from reference code, not verified with samples

> [!NOTE]
> \* Tools with known limitations. See [Known Limitations](#known-limitations) for details.

> [!TIP]
> **Help us expand tool support!** We're actively collecting sample images from experimental tools (Easy Diffusion, Fooocus) and unsupported tools. If you have sample images generated by these or other AI tools, please consider contributing them! See [CONTRIBUTING.md](CONTRIBUTING.md) for details.

## Known Limitations

> [!WARNING]
> **ComfyUI JPEG/WebP**: While reading supports major custom node formats (e.g., `save-image-extended`), writing always uses the `comfyui-saveimage-plus` format. This format provides the best information preservation and is compatible with ComfyUI's native drag-and-drop workflow loading.

> [!WARNING]
> **NovelAI WebP**: Auto-corrects corrupted UTF-8 in the Description field, which means WebP â†’ PNG â†’ WebP round-trip is not content-equivalent (but provides valid, readable metadata).

> [!WARNING]
> **SwarmUI PNGâ†’JPEG/WebP**: PNG files contain both ComfyUI workflow and SwarmUI parameters. When converting to JPEG/WebP, only parameters are preserved to match the native format. Metadata is fully preserved, but the ComfyUI workflow in the `prompt` chunk is lost.

## Usage

### Node.js Usage

```typescript
import { read, write } from 'sd-metadata';
import { readFileSync, writeFileSync } from 'fs';

// Read metadata from any supported format
const imageData = readFileSync('image.png');
const result = read(imageData);

if (result.status === 'success') {
  console.log('Tool:', result.metadata.software);       // 'novelai', 'comfyui', etc.
  console.log('Prompt:', result.metadata.prompt);
  console.log('Model:', result.metadata.model?.name);
  console.log('Size:', result.metadata.width, 'x', result.metadata.height);
}
```

### Browser Usage

```typescript
import { read } from 'sd-metadata';

// Handle file input
const fileInput = document.querySelector('input[type="file"]');
fileInput.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  const arrayBuffer = await file.arrayBuffer();
  const imageData = new Uint8Array(arrayBuffer);
  
  const result = read(imageData);
  
  if (result.status === 'success') {
    document.getElementById('tool').textContent = result.metadata.software;
    document.getElementById('prompt').textContent = result.metadata.prompt;
    document.getElementById('model').textContent = result.metadata.model?.name || 'N/A';
  }
});
```

### CDN Usage (Bookmarklet / Userscript)

For bookmarklets or userscripts (Tampermonkey, Violentmonkey, etc.), load from jsDelivr CDN:

```javascript
// Import from CDN
import { read } from 'https://cdn.jsdelivr.net/npm/@enslo/sd-metadata@latest/dist/index.js';

// Use as usual
const result = read(imageData);
if (result.status === 'success') {
  console.log('Tool:', result.metadata.software);
  console.log('Prompt:', result.metadata.prompt);
}
```

> [!TIP]
> For production use, pin to a specific version instead of `@latest`:
>
> ```text
> https://cdn.jsdelivr.net/npm/@enslo/sd-metadata@1.0.2/dist/index.js
> ```

### Format Conversion

Convert metadata between different image formats:

```typescript
import { read, write } from 'sd-metadata';

// Read from PNG
const pngData = readFileSync('comfyui-output.png');
const metadata = read(pngData);

// Write to JPEG
const jpegData = readFileSync('target.jpg');
const result = write(jpegData, metadata);

if (result.ok) {
  writeFileSync('output.jpg', result.value);
  console.log('Metadata converted from PNG to JPEG');
}
```

### Handling Different Result Types

```typescript
import { read } from 'sd-metadata';

const result = read(imageData);

switch (result.status) {
  case 'success':
    // Metadata successfully parsed
    console.log(`Generated by ${result.metadata.software}`);
    console.log(`Prompt: ${result.metadata.prompt}`);
    break;

  case 'unrecognized':
    // Metadata exists but format is not recognized
    console.log('Unknown metadata format');
    // You can still access raw metadata for debugging:
    console.log('Raw chunks:', result.raw);
    break;

  case 'empty':
    // No metadata found
    console.log('No metadata in this image');
    break;

  case 'invalid':
    // Corrupted or invalid image data
    console.log('Error:', result.message);
    break;
}
```

### Force Conversion for Unrecognized Formats

When you have unrecognized metadata but still want to convert it:

```typescript
import { read, write } from 'sd-metadata';

const source = read(unknownImage);
// source.status === 'unrecognized'

// Force blind conversion (preserves all metadata chunks/segments)
const result = write(targetImage, source, { force: true });

if (result.ok) {
  // Metadata successfully converted even though format wasn't recognized
  console.log('Forced conversion succeeded');
}
```

### Removing Metadata

To strip all metadata from an image:

```typescript
import { write } from 'sd-metadata';

const result = write(imageData, { status: 'empty' });
if (result.ok) {
  writeFileSync('clean-image.png', result.value);
}
```

## API Reference

### `read(data: Uint8Array): ParseResult`

Reads and parses metadata from an image file.

**Returns:**

- `{ status: 'success', metadata, raw }` - Successfully parsed
  - `metadata`: Unified metadata object (see `GenerationMetadata`)
  - `raw`: Original format-specific data (chunks/segments)
- `{ status: 'unrecognized', raw }` - Image has metadata but not from a known AI tool
  - `raw`: Original metadata preserved for conversion
- `{ status: 'empty' }` - No metadata found in the image
- `{ status: 'invalid', message? }` - Corrupted or unsupported image format
  - `message`: Optional error description

### `write(data: Uint8Array, metadata: ParseResult, options?: WriteOptions): WriteResult`

Writes metadata to an image file.

**Parameters:**

- `data` - Target image file data (PNG, JPEG, or WebP)
- `metadata` - `ParseResult` from `read()`
  - `status: 'success'` or `'empty'` - Can write directly
  - `status: 'unrecognized'` - Requires `force: true` option
- `options` - Optional settings:
  - `force?: boolean` - Required when writing `status: 'unrecognized'` metadata (blind conversion)

**Returns:**

- `{ ok: true, value: Uint8Array }` - Successfully written (returns new image data)
- `{ ok: false, error: { type: string, message?: string } }` - Failed
  - `type`: `'unsupportedFormat'`, `'conversionFailed'`, or `'writeFailed'`

## Type Reference

### `ParseResult`

The result of the `read()` function. It uses a discriminated union with a `status` field.

```typescript
type ParseResult =
  | { status: 'success'; metadata: GenerationMetadata; raw: RawMetadata }
  | { status: 'unrecognized'; raw: RawMetadata }
  | { status: 'empty' }
  | { status: 'invalid'; message?: string };
```

### `GenerationMetadata`

Unified metadata structure. This is a discriminated union of 5 specific metadata types.
You can use `type` (format classification) or `software` (specific tool) to narrow down the type.

```typescript
type GenerationMetadata =
  | NovelAIMetadata
  | ComfyUIMetadata
  | A1111Metadata
  | InvokeAIMetadata
  | SwarmUIMetadata;
```

#### `BaseMetadata` (Shared by all)

```typescript
interface BaseMetadata {
  /** Format classification (`novelai`, `comfyui`, `a1111`, etc.) */
  type: MetadataFormat;
  /** Specific tool name (e.g., `tensorart`, `forge`) */
  software: GenerationSoftware;
  /** Positive prompt */
  prompt: string;
  /** Negative prompt */
  negativePrompt: string;
  /** Image width */
  width: number;
  /** Image height */
  height: number;
  /** Model name, hash, VAE */
  model?: ModelSettings;
  /** Steps, CFG, seed, sampler */
  sampling?: SamplingSettings;
}
```

#### `NovelAIMetadata`

Metadata from NovelAI.

```typescript
interface NovelAIMetadata extends BaseMetadata {
  type: 'novelai';
  software: 'novelai';
  /** V4 character prompts (when using character placement) */
  characterPrompts?: Array<{
    prompt: string;
    center?: { x: number; y: number };
  }>;
  useCoords?: boolean;
  useOrder?: boolean;
}
```

#### `ComfyUIMetadata`

Metadata from ComfyUI and compatible tools (TensorArt, Stability Matrix).
Includes the full workflow graph.

```typescript
interface ComfyUIMetadata extends BaseMetadata {
  type: 'comfyui';
  software: 'comfyui' | 'tensorart' | 'stability-matrix';
  /** Full workflow JSON (for reproducibility) */
  workflow?: unknown; // Record<string, ComfyNode>
}
```

#### `A1111Metadata`

Standard metadata format used by SD WebUI, Forge, Fooocus, and many others.

```typescript
interface A1111Metadata extends BaseMetadata {
  type: 'a1111';
  software: 'sd-webui' | 'forge' | 'civitai' | 'fooocus' /* ... */;
}
```

#### `InvokeAIMetadata`

Metadata from InvokeAI.

```typescript
interface InvokeAIMetadata extends BaseMetadata {
  type: 'invokeai';
  software: 'invokeai';
}
```

#### `SwarmUIMetadata`

Metadata from SwarmUI.

```typescript
interface SwarmUIMetadata extends BaseMetadata {
  type: 'swarmui';
  software: 'swarmui';
}
```

### `RawMetadata`

Preserves the original metadata structure for lossless round-trips.

```typescript
type RawMetadata =
  | { format: 'png'; chunks: PngTextChunk[] }
  | { format: 'jpeg'; segments: MetadataSegment[] }
  | { format: 'webp'; segments: MetadataSegment[] };
```

### `GenerationSoftware`

String union of all supported software names.

```typescript
type GenerationSoftware =
  | 'novelai' | 'comfyui' | 'swarmui' | 'tensorart'
  | 'stability-matrix' | 'invokeai' | 'forge-neo' | 'forge'
  | 'sd-webui' | 'sd-next' | 'civitai' | 'hf-space'
  | 'easydiffusion' | 'fooocus' | 'ruined-fooocus';
```

## Development

```bash
# Install dependencies
npm install

# Run tests
npm test

# Watch mode
npm run test:watch

# Test coverage
npm run test:coverage

# Build
npm run build

# Lint
npm run lint
```

## License

MIT
