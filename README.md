# sd-metadata

[![npm version](https://img.shields.io/npm/v/@enslo/sd-metadata.svg)](https://www.npmjs.com/package/@enslo/sd-metadata)
[![npm downloads](https://img.shields.io/npm/dm/@enslo/sd-metadata.svg)](https://www.npmjs.com/package/@enslo/sd-metadata)
[![license](https://img.shields.io/npm/l/@enslo/sd-metadata.svg)](https://github.com/enslo/sd-metadata/blob/main/LICENSE)

A TypeScript library to read and write metadata embedded in AI-generated images.

## Features

- **Multi-format Support**: PNG (tEXt / iTXt), JPEG (COM / Exif), WebP (Exif)
- **Unified API**: Simple `read()` and `write()` functions work across all formats
- **TypeScript Native**: Written in TypeScript with full type definitions included
- **Zero Dependencies**: Works in Node.js and browsers without any external dependencies
- **Format Conversion**: Seamlessly convert metadata between PNG, JPEG, and WebP
- **Metadata Preservation**: Preserves original metadata structure when converting formats (e.g., PNG â†’ JPEG â†’ PNG maintains all original data)

## Installation

```bash
npm install @enslo/sd-metadata
```

## Tool Support

| Tool | PNG | JPEG | WebP |
| ------ | :---: | :----: | :----: |
| [NovelAI](https://novelai.net/) * | âœ… | ðŸ”„ï¸ | âœ… |
| [ComfyUI](https://github.com/comfyanonymous/ComfyUI) * | âœ… | ðŸ”„ï¸ | ðŸ”„ï¸ |
| [AUTOMATIC1111](https://github.com/AUTOMATIC1111/stable-diffusion-webui) | âš ï¸ | âš ï¸ | âš ï¸ |
| [Forge](https://github.com/lllyasviel/stable-diffusion-webui-forge) / [Forge Neo](https://github.com/neggles/sd-webui-forge-neoforge) | âœ… | âœ… | âœ… |
| [InvokeAI](https://github.com/invoke-ai/InvokeAI) | âœ… | ðŸ”„ï¸ | ðŸ”„ï¸ |
| [SwarmUI](https://github.com/Stability-AI/StableSwarmUI) * | âœ… | âœ… | âœ… |
| [Civitai](https://civitai.com/) | âš ï¸ | âœ… | âš ï¸ |
| [TensorArt](https://tensor.art/) | âœ… | ðŸ”„ï¸ | ðŸ”„ï¸ |
| [Stability Matrix](https://github.com/LykosAI/StabilityMatrix) | âœ… | ðŸ”„ï¸ | ðŸ”„ï¸ |
| [HuggingFace Space](https://huggingface.co/spaces) | âœ… | ðŸ”„ï¸ | ðŸ”„ï¸ |
| [Ruined Fooocus](https://github.com/runew0lf/RuinedFooocus) | âœ… | ðŸ”„ï¸ | ðŸ”„ï¸ |
| [Easy Diffusion](https://github.com/easydiffusion/easydiffusion) | âš ï¸ | âš ï¸ | âš ï¸ |
| [Fooocus](https://github.com/lllyasviel/Fooocus) | âš ï¸ | âš ï¸ | âš ï¸ |

**Legend:**

- âœ… **Fully Supported** - Formats natively supported by the tool, verified with sample files
- ðŸ”„ï¸ **Extended Support** - Formats not natively supported by the tool, but sd-metadata enables read/write through custom format conversion. Supports round-trip conversion back to native formats.
- âš ï¸ **Experimental** - Implemented by analyzing reference code or documentation, not verified with actual sample files. May not extract all metadata fields correctly.

**Extended Support Examples:**

- **Stability Matrix** (native: PNG only) â†’ sd-metadata enables JPEG/WebP support
- **NovelAI** (native: PNG, WebP) â†’ sd-metadata enables JPEG support

When you convert from a native format to an extended format and back (e.g., PNG â†’ JPEG â†’ PNG), all metadata is preserved.

> [!NOTE]
> \* Tools with format-specific behaviors. See [Format-Specific Behaviors](#format-specific-behaviors) for details.

> [!TIP]
> **Help us expand tool support!** We're actively collecting sample images from experimental tools (Easy Diffusion, Fooocus) and unsupported tools. If you have sample images generated by these or other AI tools, please consider contributing them! See [CONTRIBUTING.md](CONTRIBUTING.md) for details.

## Format-Specific Behaviors

Some tools have specific behaviors when converting between formats:

- **ComfyUI JPEG/WebP**: Reading supports multiple custom node formats (e.g., `save-image-extended`), but writing always uses the `comfyui-saveimage-plus` format for best information preservation and compatibility with ComfyUI's native drag-and-drop workflow loading.
- **NovelAI WebP**: Automatically corrects corrupted UTF-8 in the Description field. WebP â†’ PNG â†’ WebP round-trip produces valid, readable metadata but with minor text corrections.
- **SwarmUI PNGâ†’JPEG/WebP**: Native SwarmUI JPEG/WebP files do not include node information. When converting from PNG, this library preserves the ComfyUI workflow in the `Make` field for complete metadata retention (extended support).

## Import

**ESM (TypeScript / Modern JavaScript):**

```typescript
import { read } from '@enslo/sd-metadata';
```

**CommonJS (Node.js):**

```javascript
const { read } = require('@enslo/sd-metadata');
```

> [!NOTE]
> All examples below use ESM syntax. CommonJS users can replace `import` with `require`.

## Usage

### Node.js Usage

```typescript
import { read, write } from 'sd-metadata';
import { readFileSync, writeFileSync } from 'fs';

// Read metadata from any supported format
const imageData = readFileSync('image.png');
const result = read(imageData);

if (result.status === 'success') {
  console.log('Tool:', result.metadata.software);       // 'novelai', 'comfyui', etc.
  console.log('Prompt:', result.metadata.prompt);
  console.log('Model:', result.metadata.model?.name);
  console.log('Size:', result.metadata.width, 'x', result.metadata.height);
}
```

### Browser Usage

```typescript
import { read } from 'sd-metadata';

// Handle file input
const fileInput = document.querySelector('input[type="file"]');
fileInput.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  
  const arrayBuffer = await file.arrayBuffer();
  const imageData = new Uint8Array(arrayBuffer);
  
  const result = read(imageData);
  
  if (result.status === 'success') {
    document.getElementById('tool').textContent = result.metadata.software;
    document.getElementById('prompt').textContent = result.metadata.prompt;
    document.getElementById('model').textContent = result.metadata.model?.name || 'N/A';
  }
});
```

### CDN Usage (Bookmarklet / Userscript)

For bookmarklets or userscripts (Tampermonkey, Violentmonkey, etc.), load from jsDelivr CDN:

```javascript
// Import from CDN
import { read } from 'https://cdn.jsdelivr.net/npm/@enslo/sd-metadata@latest/dist/index.js';

// Fetch image and read metadata
const response = await fetch(imageUrl);
const arrayBuffer = await response.arrayBuffer();
const imageData = new Uint8Array(arrayBuffer);

const result = read(imageData);
if (result.status === 'success') {
  console.log('Tool:', result.metadata.software);
  console.log('Prompt:', result.metadata.prompt);
}
```

> [!TIP]
> For production use, pin to a specific version instead of `@latest`:
>
> ```text
> https://cdn.jsdelivr.net/npm/@enslo/sd-metadata@1.1.0/dist/index.js
> ```

### Format Conversion

Convert metadata between different image formats:

```typescript
import { read, write } from 'sd-metadata';

// Read metadata from PNG
const pngData = readFileSync('comfyui-output.png');
const parseResult = read(pngData);

if (parseResult.status === 'success') {
  // Convert PNG to JPEG (using your preferred image processing library)
  const jpegImageData = convertToJpeg(pngData); // Pseudo-code: use sharp, canvas, etc.
  
  // Embed the metadata into the JPEG
  const result = write(jpegImageData, parseResult);
  
  if (result.ok) {
    writeFileSync('output.jpg', result.value);
    console.log('Image converted to JPEG with metadata preserved');
  }
}
```

> [!TIP]
> This library handles metadata read/write only. For actual image format conversion (decoding/encoding pixels), use image processing libraries like [sharp](https://www.npmjs.com/package/sharp), [jimp](https://www.npmjs.com/package/jimp), or browser Canvas API.

### Handling Different Result Types

```typescript
import { read } from 'sd-metadata';

const result = read(imageData);

switch (result.status) {
  case 'success':
    // Metadata successfully parsed
    console.log(`Generated by ${result.metadata.software}`);
    console.log(`Prompt: ${result.metadata.prompt}`);
    break;

  case 'unrecognized':
    // Metadata exists but format is not recognized
    console.log('Unknown metadata format');
    // You can still access raw metadata for debugging:
    console.log('Raw chunks:', result.raw);
    break;

  case 'empty':
    // No metadata found
    console.log('No metadata in this image');
    break;

  case 'invalid':
    // Corrupted or invalid image data
    console.log('Error:', result.message);
    break;
}
```

### Force Conversion for Unrecognized Formats

When you have unrecognized metadata but still want to convert it:

```typescript
import { read, write } from 'sd-metadata';

const source = read(unknownImage);
// source.status === 'unrecognized'

// Force blind conversion (preserves all metadata chunks/segments)
const result = write(targetImage, source, { force: true });

if (result.ok) {
  // Metadata successfully converted even though format wasn't recognized
  console.log('Forced conversion succeeded');
}
```

### Removing Metadata

To strip all metadata from an image:

```typescript
import { write } from 'sd-metadata';

const result = write(imageData, { status: 'empty' });
if (result.ok) {
  writeFileSync('clean-image.png', result.value);
}
```

## API Reference

### `read(data: Uint8Array): ParseResult`

Reads and parses metadata from an image file.

**Returns:**

- `{ status: 'success', metadata, raw }` - Successfully parsed
  - `metadata`: Unified metadata object (see `GenerationMetadata`)
  - `raw`: Original format-specific data (chunks/segments)
- `{ status: 'unrecognized', raw }` - Image has metadata but not from a known AI tool
  - `raw`: Original metadata preserved for conversion
- `{ status: 'empty' }` - No metadata found in the image
- `{ status: 'invalid', message? }` - Corrupted or unsupported image format
  - `message`: Optional error description

### `write(data: Uint8Array, metadata: ParseResult, options?: WriteOptions): WriteResult`

Writes metadata to an image file.

**Parameters:**

- `data` - Target image file data (PNG, JPEG, or WebP)
- `metadata` - `ParseResult` from `read()`
  - `status: 'success'` or `'empty'` - Can write directly
  - `status: 'unrecognized'` - Requires `force: true` option
- `options` - Optional settings:
  - `force?: boolean` - Required when writing `status: 'unrecognized'` metadata (blind conversion)

**Returns:**

- `{ ok: true, value: Uint8Array }` - Successfully written (returns new image data)
- `{ ok: false, error: { type: string, message?: string } }` - Failed
  - `type`: `'unsupportedFormat'`, `'conversionFailed'`, or `'writeFailed'`

## Type Reference

This section provides an overview of the main types. For complete type definitions, see [Type Documentation](./docs/types.md).

### `ParseResult`

The result of the `read()` function. It uses a discriminated union with a `status` field.

```typescript
type ParseResult =
  | { status: 'success'; metadata: GenerationMetadata; raw: RawMetadata }
  | { status: 'unrecognized'; raw: RawMetadata }
  | { status: 'empty' }
  | { status: 'invalid'; message?: string };
```

### `GenerationMetadata`

Unified metadata structure returned by the `read()` function. This is a discriminated union of 3 specific metadata types, distinguished by the `software` field.

**Common Fields (Available in All Types):**

All metadata types include these base fields:

- `prompt: string` - Positive prompt text
- `negativePrompt: string` - Negative prompt text
- `width: number` - Image width in pixels
- `height: number` - Image height in pixels
- `model?: ModelSettings` - Model information (name, hash, VAE)
- `sampling?: SamplingSettings` - Sampling parameters (seed, steps, CFG, sampler, scheduler, clipSkip)
- `hires?: HiresSettings` - Hires.fix settings (if applied)
- `upscale?: UpscaleSettings` - Upscale settings (if applied)

**Metadata Type Variants:**

- **`NovelAIMetadata`** (`software: 'novelai'`)  
  Includes NovelAI-specific fields for V4 character placement:
  - `characterPrompts?: CharacterPrompt[]` - Per-character prompts with positions
  - `useCoords?: boolean` - Use character coordinates for placement
  - `useOrder?: boolean` - Use character order

- **`ComfyUIMetadata`** (`software: 'comfyui' | 'tensorart' | 'stability-matrix' | 'swarmui'`)  
  Includes ComfyUI workflow graph:
  - `nodes: ComfyNodeGraph` (required for comfyui/tensorart/stability-matrix)
  - `nodes?: ComfyNodeGraph` (optional for swarmui - only in PNG format)

- **`StandardMetadata`** (`software: 'sd-webui' | 'forge' | 'invokeai' | 'civitai' | ...`)  
  Baseline metadata without tool-specific extensions. Used by most SD WebUI-based tools.

**Type Definition:**

```typescript
type GenerationMetadata =
  | NovelAIMetadata
  | ComfyUIMetadata
  | StandardMetadata;
```

**Usage Example:**

```typescript
const result = read(imageData);

if (result.status === 'success') {
  const metadata = result.metadata;
  
  // Access common fields
  console.log('Prompt:', metadata.prompt);
  console.log('Model:', metadata.model?.name);
  console.log('Seed:', metadata.sampling?.seed);
  
  // Type-specific handling using discriminated union
  if (metadata.software === 'novelai') {
    // TypeScript knows this is NovelAIMetadata
    console.log('Character prompts:', metadata.characterPrompts);
  } else if (
    metadata.software === 'comfyui' ||
    metadata.software === 'tensorart' ||
    metadata.software === 'stability-matrix'
  ) {
    // TypeScript knows this is BasicComfyUIMetadata (nodes always present)
    console.log('Node count:', Object.keys(metadata.nodes).length);
  } else if (metadata.software === 'swarmui') {
    // TypeScript knows this is SwarmUIMetadata (nodes optional)
    if (metadata.nodes) {
      console.log('Workflow included');
    }
  }
}
```

See [Type Documentation](./docs/types.md) for detailed interface definitions of each metadata type.

### `RawMetadata`

Preserves the original metadata structure for round-trip conversions.

```typescript
type RawMetadata =
  | { format: 'png'; chunks: PngTextChunk[] }
  | { format: 'jpeg'; segments: MetadataSegment[] }
  | { format: 'webp'; segments: MetadataSegment[] };
```

> [!TIP]
> For TypeScript users: All types are exported and available for import.
>
> ```typescript
> import type { 
>   ParseResult, 
>   GenerationMetadata, 
>   ModelSettings, 
>   SamplingSettings 
> } from '@enslo/sd-metadata';
> ```
>
> Use your IDE's IntelliSense for auto-completion and inline documentation.

For detailed documentation of all exported types including `BaseMetadata`, `ModelSettings`, `SamplingSettings`, and format-specific types, see the [Type Documentation](./docs/types.md).

## Development

```bash
# Install dependencies
npm install

# Run tests
npm test

# Watch mode
npm run test:watch

# Test coverage
npm run test:coverage

# Build
npm run build

# Lint
npm run lint
```

## License

MIT
